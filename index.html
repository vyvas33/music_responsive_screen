<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music Responsive Webscreen (Single Color, Translucent File Input)</title>
  <style>
    /* Basic reset */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background-color: black;
      font-family: sans-serif;
      color: white;
    }

    /* A translucent control bar at the top */
    #controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.1); /* translucent */
      padding: 10px;
    }

    /* Icon-like buttons */
    button {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    button:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Translucent File Input */
    #fileInput {
      font-size: 14px;
      padding: 6px;
      cursor: pointer;
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      transition: background 0.2s;
    }
    #fileInput:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    /* Make the default "Choose File" button match styling (for Chromium-based browsers) */
    #fileInput::-webkit-file-upload-button {
      cursor: pointer;
      background: none;
      border: none;
      color: #fff;
      font-size: 14px;
    }

    /* Range sliders (track position & threshold) */
    input[type="range"] {
      -webkit-appearance: none;
      width: 120px;
      background: transparent;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 14px;
      width: 14px;
      border-radius: 50%;
      background: white;
      border: 1px solid #888;
      margin-top: -5px;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: rgba(255,255,255,0.4);
      border-radius: 2px;
    }

    /* Labels */
    label {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      font-size: 12px;
      color: #fff;
    }
    #thresholdInput {
      width: 60px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 4px;
      margin-top: 4px;
      transition: background 0.2s;
    }
    #thresholdInput:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Translucent Color Picker */
    #colorInput {
      width: 50px;
      height: 30px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: background 0.2s;
    }
    #colorInput:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Position slider container so it lines up nicely in the controls */
    #trackSliderContainer {
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }
    #trackSliderLabel {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>

  <div id="controls">
    <!-- Translucent File Input -->
    <input type="file" id="fileInput" accept="audio/*">

    <!-- Buttons -->
    <button id="startBtn" disabled>▶︎</button>
    <button id="pauseBtn" disabled>⏸</button>
    <button id="restartBtn" disabled>↺</button>

    <!-- Track Slider -->
    <div id="trackSliderContainer">
      <span id="trackSliderLabel">Track</span>
      <input type="range" id="trackSlider" value="0" min="0" step="0.01">
    </div>

    <!-- Threshold Input -->
    <label>
      Threshold
      <input type="number" id="thresholdInput" value="20" min="0" max="255">
    </label>

    <!-- Translucent Color Input -->
    <label>
      Flicker Color
      <input type="color" id="colorInput" value="#ff0000">
    </label>
  </div>

  <!-- Hidden audio element -->
  <audio id="audio" crossorigin="anonymous"></audio>

  <script>
    let audioContext;
    let analyser;
    let audioSource;
    let audioInitialized = false;

    // Default threshold and color
    let threshold = 20;
    let flickerColor = '#ff0000';

    // DOM elements
    const fileInput      = document.getElementById('fileInput');
    const audioEl        = document.getElementById('audio');
    const startBtn       = document.getElementById('startBtn');
    const pauseBtn       = document.getElementById('pauseBtn');
    const restartBtn     = document.getElementById('restartBtn');
    const thresholdInput = document.getElementById('thresholdInput');
    const colorInput     = document.getElementById('colorInput');
    const trackSlider    = document.getElementById('trackSlider');

    // 1. Load audio from file input
    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      audioEl.src = url;

      audioInitialized = true;

      // Enable buttons
      startBtn.disabled = false;
      pauseBtn.disabled = false;
      restartBtn.disabled = false;

      // When the audio metadata is loaded, set the track slider max to the duration
      audioEl.addEventListener('loadedmetadata', () => {
        trackSlider.max = audioEl.duration.toFixed(2);
      });

      // Set up audio processing if not already set
      setupAudioProcessing();
    });

    // 2. Set up audio context and analyser
    function setupAudioProcessing() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (!analyser) {
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
      }
      if (!audioSource) {
        audioSource = audioContext.createMediaElementSource(audioEl);
        audioSource.connect(analyser);
        analyser.connect(audioContext.destination);
      }
      animate();
    }

    // 3. Animation loop for amplitude-based flicker
    function animate() {
      requestAnimationFrame(animate);
      if (!analyser) return;

      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteTimeDomainData(dataArray);

      let sum = 0;
      for (let i = 0; i < bufferLength; i++) {
        const val = dataArray[i] - 128; // shift range to -128..127
        sum += val * val;
      }
      const rms = Math.sqrt(sum / bufferLength);

      // Flicker if above threshold
      document.body.style.backgroundColor = (rms > threshold) ? flickerColor : 'black';
    }

    // 4. Threshold & Color input changes
    thresholdInput.addEventListener('input', () => {
      threshold = parseInt(thresholdInput.value, 10) || 0;
    });
    colorInput.addEventListener('input', () => {
      flickerColor = colorInput.value;
    });

    // 5. Button handlers
    startBtn.addEventListener('click', () => {
      if (!audioInitialized) return;
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      audioEl.play();
    });

    pauseBtn.addEventListener('click', () => {
      if (!audioInitialized) return;
      audioEl.pause();
    });

    restartBtn.addEventListener('click', () => {
      if (!audioInitialized) return;
      audioEl.currentTime = 0;
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      audioEl.play();
    });

    // 6. Track slider scrubbing
    audioEl.addEventListener('timeupdate', () => {
      trackSlider.value = audioEl.currentTime;
    });
    trackSlider.addEventListener('input', () => {
      if (!audioInitialized) return;
      audioEl.currentTime = parseFloat(trackSlider.value);
    });
  </script>
</body>
</html>
